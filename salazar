@echo off
setlocal enabledelayedexpansion

:: Retrieve username and password from master batch file
set USERNAME=%1
set PASSWORD=%2

:: Define the status cycle
set status_cycle=open todo refining "waiting for dependencies" "ready to start" "in progress" done

:ISSUE_LOOP
:: Reset variables
set "ISSUE_KEY="
set "desired_status="
set "current_status="
set "next_status="
set "transition_id="
set "count=0"
set "status_choice_count=0"

:: Prompt the user for the issue key
set /p ISSUE_KEY="Enter the Jira issue key (e.g., ABC-123) or type 'exit' to quit: "

:: Check if the user wants to exit
if /i "%ISSUE_KEY%"=="exit" (
    echo Exiting the script.
    goto END
)

:: Display status options
echo Select the desired status:
for %%s in (%status_cycle%) do (
    set /a count+=1
    echo [!count!] %%s
)

:: Prompt the user to select a status
set /p status_choice="Enter the number corresponding to the desired status: "

:: Map the user's choice to the corresponding status
for /l %%i in (1,1,%count%) do (
    if %status_choice%==%%i (
        for %%s in (%status_cycle%) do (
            set /a status_choice_count+=1
            if !status_choice_count! equ %%i set "desired_status=%%s"
        )
    )
)

:: Check if the user provided a valid option
if "!desired_status!"=="" (
    echo Invalid selection. Exiting...
    exit /b 1
)

echo You selected: !desired_status!

:: Set the Jira URL
set JIRA_URL=https://track.td.com

:: Get the current status of the Jira issue
curl -s -u %USERNAME%:%PASSWORD% -X GET -H "Content-Type: application/json" %JIRA_URL%/rest/api/2/issue/%ISSUE_KEY%?fields=status > current_status.json

:: Debug: Output the JSON to ensure it's correct
echo --- DEBUG: JSON Content ---
type current_status.json
echo ---------------------------

:: Initialize the current_status variable
set "current_status="

:: Extract the "name" field under the "status" section from the JSON
for /f "delims=" %%i in (current_status.json) do (
    echo %%i | findstr /i "\"name\"" >nul && (
        echo %%i | findstr /i "\"status\"" >nul && set "status_line=%%i"
    )
)

:: Debug: Output the status line
echo --- DEBUG: Status Line ---
echo !status_line!
echo --------------------------

:: Extract the name field from the status_line
for /f "tokens=1,2 delims=:," %%a in ("%status_line%") do (
    if "%%a"==" \"name\"" set "current_status=%%~b"
)

:: Clean up the extracted value
set current_status=%current_status:"=%

:: Debug: Output the extracted status
echo --- DEBUG: Extracted Status ---
echo !current_status!
echo --------------------------------

:: Check if current_status was set correctly
if "%current_status%"=="" (
    echo Error: Failed to extract the current status.
    goto END
)

echo Current status is: !current_status!

:: Determine the optimal path
set "found_start="
set "found_desired="
for %%s in (%status_cycle%) do (
    if /i "!current_status!"=="%%s" set found_start=1
    if /i "!desired_status!"=="%%s" if defined found_start set found_desired=1
    if defined found_start if not defined found_desired set "next_status=%%s"
)

:: Directly transition if path not found
if not defined next_status (
    echo Optimal path not found, attempting direct transition to !desired_status!.
    set "next_status=!desired_status!"
)

:: Get available transitions for the current status
set TRANSITION_URL=%JIRA_URL%/rest/api/2/issue/%ISSUE_KEY%/transitions
curl -s -u %USERNAME%:%PASSWORD% -X GET -H "Content-Type: application/json" %TRANSITION_URL% > transitions.json

:: Search for the next status in the available transitions
for /f "tokens=3 delims=:," %%c in ('findstr /i /c:"!next_status!" transitions.json') do (
    set "transition_id=%%c"
    set "transition_id=!transition_id:"=!"
)

:: If a transition is found, apply it
if defined transition_id (
    echo Transitioning to: !next_status! with ID: !transition_id!
    curl -u %USERNAME%:%PASSWORD% -X POST --data "{\"transition\": {\"id\": \"!transition_id!\"}}" -H "Content-Type: application/json" %TRANSITION_URL%
) else (
    echo No valid transition found to !next_status!. Please check the Jira workflow.
)

goto ISSUE_LOOP

:END
echo Script has ended.

endlocal
