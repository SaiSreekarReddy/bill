@echo off
setlocal enabledelayedexpansion

:: Retrieve username and password from master batch file
set USERNAME=%1
set PASSWORD=%2

:ISSUE_LOOP
:: Reset variables
set ISSUE_KEY=
set status_choice=
set desired_status=
set current_status=
set next_status=
set transition_id=

:: Prompt the user for the issue key
set /p ISSUE_KEY="Enter the Jira issue key (e.g., ABC-123) or type 'exit' to quit: "

:: Check if the user wants to exit
if /i "%ISSUE_KEY%"=="exit" (
    echo Exiting the script.
    goto END
)

:: Display status options
echo Select the desired status:
echo [1] Open
echo [2] To Do
echo [3] Refining
echo [4] Waiting for Dependencies
echo [5] Ready to Start
echo [6] In Progress
echo [7] Done

:: Prompt the user to select a status
set /p status_choice="Enter the number corresponding to the desired status: "

:: Map the user's choice to the corresponding status
set status[1]=open
set status[2]=todo
set status[3]=refining
set status[4]=waiting for dependencies
set status[5]=ready to start
set status[6]=in progress
set status[7]=done

set desired_status=!status[%status_choice%]!

:: Check if the user provided a valid option
if "!desired_status!"=="" (
    echo Invalid selection. Exiting...
    exit /b 1
)

echo You selected: !desired_status!

:: Set the Jira URL
set JIRA_URL=https://track.td.com

:START_LOOP
:: Get the current status of the Jira issue
curl -s -u %USERNAME%:%PASSWORD% -X GET -H "Content-Type: application/json" %JIRA_URL%/rest/api/2/issue/%ISSUE_KEY%?fields=status > current_status.json

:: Extract the last status name from JSON
for /f "tokens=2 delims=:" %%a in ('findstr /i "\"name\"" current_status.json') do (
    set "current_status=%%a"
)

:: Clean up the extracted value by removing unwanted characters
set current_status=%current_status:,=%
set current_status=%current_status:"=%
set current_status=%current_status: }=%
set current_status=%current_status:]=%

echo Current status is: !current_status!

:: Manually define the transition paths based on known workflow
if /i "!current_status!"=="todo" (
    if /i "!desired_status!"=="refining" (
        set next_status=ready to start
    )
)

if /i "!current_status!"=="ready to start" (
    if /i "!desired_status!"=="refining" (
        set next_status=refining
    )
)

:: Check if we've already reached the desired status
if "!current_status!"=="!desired_status!" (
    echo Desired status !desired_status! already reached.
    goto NEXT_ISSUE
)

if "!next_status!"=="" (
    echo No valid transition found from !current_status! to !desired_status!.
    goto NEXT_ISSUE
)

:: Get available transitions for the current status
set TRANSITION_URL=%JIRA_URL%/rest/api/2/issue/%ISSUE_KEY%/transitions
curl -s -u %USERNAME%:%PASSWORD% -X GET -H "Content-Type: application/json" %TRANSITION_URL% > transitions.json

:: Search for the next status in the available transitions
set transition_id=
for /f "tokens=*" %%c in ('findstr /i /c:"!next_status!" transitions.json') do (
    for /f "tokens=3 delims=:," %%d in ("%%c") do (
        set transition_id=%%d
        set transition_id=!transition_id:"=!
    )
)

:: If a transition is found, apply it
if defined transition_id (
    echo Transitioning to: !next_status! with ID: !transition_id!
    curl -u %USERNAME%:%PASSWORD% -X POST --data "{\"transition\": {\"id\": \"!transition_id!\"}}" -H "Content-Type: application/json" %TRANSITION_URL%
    goto START_LOOP
) else (
    echo Transition to !next_status! not available.
)

:NEXT_ISSUE
echo Transition process completed for issue %ISSUE_KEY%.
echo.
goto ISSUE_LOOP

:END
echo Script has ended.

endlocal
