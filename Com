@echo off
setlocal enabledelayedexpansion

:: Prompt for Jira username
set /p username="Enter Jira Username: "
echo Username entered: %username%

:: Masked password input
call :HInput

echo(
echo Password captured successfully.

set "password=%Line%"
set "jiraUrl=https://track.td.com"
set "defaultComment=The file is uploaded"
set "defaultStatus=2"  :: Default to Done if no status is entered

:main
:loop
:: Reset variables
set "ticketNumber="
set "ticketInput="
set "statusSelection="
set "skipComment="

:: Prompt for Jira ticket number or URL, keep prompting until valid input is provided
:ticketPrompt
set /p ticketInput="Enter Jira Ticket Number or URL (or type 'exit' to quit): "
if /i "!ticketInput!"=="exit" goto :end

:: Extract the ticket number if a URL is provided
for /f "tokens=2 delims=/browse/" %%i in ("!ticketInput!") do set "ticketNumber=%%i"
if not defined ticketNumber set "ticketNumber=!ticketInput!"

if "!ticketNumber!"=="" (
    echo Ticket number cannot be empty.
    goto ticketPrompt
)

set /p jiraComment="Enter Jira Comment (type 'def' for default, leave blank to skip): "

:: Check for default comment
if /i "!jiraComment!"=="def" (
    set "jiraComment=%defaultComment%"
) else if "!jiraComment!"=="" (
    set "skipComment=true"
) else (
    set "skipComment=false"
)
echo !jiraComment!
:: Prompt for desired status
echo Select the desired status:
echo 1. In Progress
echo 2. Done
echo 3. Reopen
set /p statusSelection="Enter the number corresponding to the desired status (default is Done): "

if "!statusSelection!"=="" set "statusSelection=%defaultStatus%"

if "!statusSelection!"=="1" (
    set "desiredStatus=In Progress"
) else if "!statusSelection!"=="2" (
    set "desiredStatus=Done"
) else if "!statusSelection!"=="3" (
    set "desiredStatus=Reopen"
) else (
    echo Invalid selection.
    goto loop
)

:: Determine the appropriate transition IDs based on ticket number pattern
set "openTransitionId="
set "refiningTransitionId="
set "waitingOnDependencyTransitionId="
set "readyToStartTransitionId="
set "inProgressTransitionId="
set "closeTransitionId="

if /i "!ticketNumber:~0,3!"=="CEM" (
    set "openTransitionId=11"
    set "closeTransitionId=51"
    echo "Its CEM"
) else if /i "!ticketNumber:~0,7!"=="CRPHUCC" (
    set "openTransitionId=1081"
    set "refiningTransitionId=701"
    set "waitingOnDependencyTransitionId=681"
    set "readyToStartTransitionId=691"
    set "inProgressTransitionId=711"
    set "closeTransitionId=411"
    echo "Its UCC or Corecarl"
) else (
    set "openTransitionId=1081"
    set "refiningTransitionId=701"
    set "waitingOnDependencyTransitionId=681"
    set "readyToStartTransitionId=691"
    set "inProgressTransitionId=711"
    set "closeTransitionId=411"
    echo "Check your ticket number, maybe it's not supported here. Using generic IDs."
)

:: Get current status of the ticket
curl -u %username%:%password% -X GET -H "Content-Type: application/json" %jiraUrl%/rest/api/2/issue/%ticketNumber%?fields=status > ticketStatus.json

for /f "tokens=3 delims=:, " %%i in ('findstr /C:"\"id\"" ticketStatus.json') do set "currentStatusId=%%i"
del ticketStatus.json

:: If the ticket is closed (status ID is 51 or 411), reopen it first
if "!currentStatusId!"=="51" (
    echo Ticket is closed. Reopening it first.
    curl -u %username%:%password% -X POST -H "Content-Type: application/json" -d "{\"transition\": {\"id\": \"%openTransitionId%\"}}" %jiraUrl%/rest/api/2/issue/%ticketNumber%/transitions
) else if "!currentStatusId!"=="411" (
    echo Ticket is closed. Reopening it first.
    curl -u %username%:%password% -X POST -H "Content-Type: application/json" -d "{\"transition\": {\"id\": \"%openTransitionId%\"}}" %jiraUrl%/rest/api/2/issue/%ticketNumber%/transitions
)

:: Function to transition the Jira ticket
call :transition_jira_ticket

:: Add comment to the issue if not skipped
if "!skipComment!"=="true" (
    echo No comment added for ticket %ticketNumber%.
) else (
    curl -u %username%:%password% -X POST -H "Content-Type: application/json" -d "{\"body\": \"%jiraComment%\"}" %jiraUrl%/rest/api/2/issue/%ticketNumber%/comment
    echo Comment added for ticket %ticketNumber%.
)

echo Transition to %desiredStatus% completed for ticket %ticketNumber%.
goto loop

:end
pause
exit /b

:HInput
:: Version 3.0
SetLocal DisableDelayedExpansion
Echo Enter your password below:
Set "Line="
Rem Save 0x08 character in BS variable
For /F %%# In ('"Prompt;$H&For %%# in (1) Do Rem"') Do Set "BS=%%#"

:HILoop
Set "Key="
For /F "delims=" %%# In ('Xcopy /W "%~f0" "%~f0" 2^>Nul') Do If Not Defined Key Set "Key=%%#"
Set "Key=%Key:~-1%"
SetLocal EnableDelayedExpansion
If Not Defined Key Goto :HIEnd 
If %BS%==^%Key% (Set /P "=%BS% %BS%" <Nul
Set "Key="
If Defined Line Set "Line=!Line:~0,-1!"
) Else Set /P "=*" <Nul
If Not Defined Line (EndLocal &Set "Line=%Key%"
) Else For /F delims^=^ eol^= %%# In (
"!Line!") Do EndLocal &Set "Line=%%#%Key%"
Goto :HILoop

:HIEnd
Echo(
Goto :Eof

:transition_jira_ticket
if "!desiredStatus!"=="In Progress" (
    curl -u %username%:%password% -X POST -H "Content-Type: application/json" -d "{\"transition\": {\"id\": \"%openTransitionId%\"}}" %jiraUrl%/rest/api/2/issue/%ticketNumber%/transitions
    curl -u %username%:%password% -X POST -H "Content-Type: application/json" -d "{\"transition\": {\"id\": \"%refiningTransitionId%\"}}" %jiraUrl%/rest/api/2/issue/%ticketNumber%/transitions
    curl -u %username%:%password% -X POST -H "Content-Type: application/json" -d "{\"transition\": {\"id\": \"%waitingOnDependencyTransitionId%\"}}" %jiraUrl%/rest/api/2/issue/%ticketNumber%/transitions
    curl -u %username%:%password% -X POST -H "Content-Type: application/json" -d "{\"transition\": {\"id\": \"%readyToStartTransitionId%\"}}" %jiraUrl%/rest/api/2/issue/%ticketNumber%/transitions
    curl -u %username%:%password% -X POST -H "Content-Type: application/json" -d "{\"transition\": {\"id\": \"%inProgressTransitionId%\"}}" %jiraUrl%/rest/api/2/issue/%ticketNumber%/transitions
    echo "Changed to In Progress"
    goto :eof
)

if "!desiredStatus!"=="Done" (
    curl -u %username%:%password% -X POST -H "Content-Type: application/json" -d "{\"transition\": {\"id\": \"%openTransitionId%\"}}" %jiraUrl%/rest/api/2/issue/%ticketNumber%/transitions
    curl -u %username%:%password% -X POST -H "Content-Type: application/json" -d "{\"transition\": {\"id\": \"%refiningTransitionId%\"}}" %jiraUrl%/rest/api/2/issue/%ticketNumber%/transitions
    curl -u %username%:%password% -X POST -H "Content-Type: application/json" -d "{\"transition\": {\"id\": \"%waitingOnDependencyTransitionId%\"}}" %jiraUrl%/rest/api/2/issue/%ticketNumber%/transitions
    curl -u %username%:%password% -X POST -H "Content-Type: application/json" -d "{\"transition\": {\"id\": \"%readyToStartTransitionId%\"}}" %jiraUrl%/rest/api/2/issue/%ticketNumber%/transitions
    curl -u %username%:%password% -X POST -H "Content-Type: application/json" -d "{\"transition\": {\"id\": \"%inProgressTransitionId%\"}}" %jiraUrl%/rest/api/2/issue/%ticketNumber%/transitions
    curl -u %username%:%password% -X POST -H "Content-Type: application/json" -d "{\"transition\": {\"id\": \"%closeTransitionId%\"}}" %jiraUrl%/rest/api/2/issue/%ticketNumber%/transitions
    echo "Changed to Done"
    goto :eof
)

if "!desiredStatus!"=="Reopen" (
    curl -u %username%:%password% -X POST -H "Content-Type: application/json" -d "{\"transition\": {\"id\": \"%openTransitionId%\"}}" %jiraUrl%/rest/api/2/issue/%ticketNumber%/transitions
    echo "Changed to Reopen"
    goto :eof
)

goto :eof
